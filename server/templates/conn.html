{% extends "base.html" %}

{% block title %}MPO Workflow Detail{% endblock %}

{% block hscripts %}

<script>

function closepop(id) {
	$('#'+id).popover('hide');
}

function showComments() {
	$( "#node_comments" ).toggle();
}

//handles the svg workflow plot functionality
$(document).ready(function () {
		wf_desc="{{ wid_info[0].description }}";	
		var jsondata = '{{ nodes|tojson }}';  //single quote issue
		var tmp_str=jsondata.replace(/&#34;/g,'"');
		tmp_str=tmp_str.replace(/(\r\n|\n|\r)/g,'<br/>');
		tmp_str=tmp_str.replace(/&#39;/g,'\''); //replace single quote with \'
		tmp_str=tmp_str.replace(/\\/g, "\\\\");  //replace single backslash with double \\
		var jdata=tmp_str;
		//console.log(jdata);

		var dataObjs=jQuery.parseJSON(jdata);
		//alert(JSON.stringify(dataObjs[4].data));
		
		var dataElements = {}; //for name - desc in popover
		
		name='';
		desc='';
		for (var key in dataObjs) {
		  if (dataObjs.hasOwnProperty(key)) {
			var tmp = dataObjs[key];
			for(var j in tmp) {
				if(j=="data") {
					//alert(JSON.stringify(tmp[j]));
					var tmp2=tmp[j];
					var tmp3=tmp2[0];
					if(tmp3['time'])
						dataElements[tmp['name']]=tmp3['description'] + ' - ' + tmp3['time'];
					else
						dataElements[tmp['name']]=tmp3['description'];
					if(tmp3['uri'])
						dataElements[tmp['name']]+="<ul><li><small>uri: "+tmp3['uri']+"</small></li><li><small>"+tmp3['uid']+"</small></li></ul>";
				}
				else if(j=="metadata") {
					var tmp2=tmp[j];
					dataElements[tmp['name']]=dataElements[tmp['name']]+"<div>metadata:<ul>";
					for (var z in tmp2)
					{
						var tmp3=tmp2[z];
						if(tmp3['key']) {
							dataElements[tmp['name']]=dataElements[tmp['name']] + "<li>" + tmp3['key'] + ': ' + tmp3['value'] + "</li>";
						}
					}
					dataElements[tmp['name']]=dataElements[tmp['name']]+"</ul></div>";
				}
			}
		  }
		}
		//alert(JSON.stringify(dataElements));
			
		var lastPopover='';
		var currentPopover='';

		//$("#test").popover({title: "this is a popover", html: true, container: 'body', content: '<ul><li><a href="#">metadata 1</a></li><li>metadata 2</li><li>metadata 3</li><li>add comment</li></ul>', trigger: 'hover'});
		//checks and adjusts svg width/height if needed
		//var workflowWidth=560; //in pixels
		//var workflowWidth=550;
		var workflowWidth=500;

		var w =	document.getElementsByTagName("svg").item(0).getAttribute("width");	
		var h =	document.getElementsByTagName("svg").item(0).getAttribute("height");
		var width=parseInt(w.replace("pt",""));
		var height=parseInt(h.replace("pt",""));
		
		if(width > workflowWidth) {
			var wnew=Math.round(width*(workflowWidth/width));
			var hnew=Math.round(height*(workflowWidth/width));
			w=wnew.toString() + "pt";
			h=hnew.toString() + "pt";
			document.getElementsByTagName("svg").item(0).setAttribute("width",w);
			document.getElementsByTagName("svg").item(0).setAttribute("height",h);
		}
		//end svg size adjust
				
		//get list of nodes for svg xml tag "g" w/ class "node"
		var nodelist = document.querySelectorAll("g.node");
				
		//parse nodelist object and add click event function to each node (w/ respective data)
		for (var key in nodelist) {
		  if (nodelist.hasOwnProperty(key)) {
		    var node=nodelist[key];
			var id="";
			
			var sub_content="";
			//get id of "g" element of class=nodes
			if(key==0) {
				id="node1";
				var wid=node.childNodes[0].textContent;
				sub_content=wf_desc;
			}
			else
				id=node.childNodes[0].textContent;	
			
			//get current text content of node and add a link -- *use svg xlink instead*
			//var nodeText=node.childNodes[4].textContent;
			//node.childNodes[4].textContent='<a href="/">' + nodeText + '</a>';
			
			//create new ID attribute for <text> v.1
			//var addTextID = document.createAttribute('id');
			//addTextID.value = "text_" + id;
			//node.childNodes[4].setAttributeNode(addTextID);

			//create new ID attribute for <text> v.2
			node.childNodes[2].setAttribute("fill","white"); //shapes fill color
			node.childNodes[4].setAttribute("style",'fill:rgb(0,76,153);cursor:pointer;'); //text styles
			node.childNodes[4].setAttribute("id","text_" + id); //id links popover menu
			//node.childNodes[4].id = "text_" + id; 
			
			//link popover to new text_id
			//var popcontent='<div><span>'+ node.childNodes[4].textContent +': <br/><small><em>' + dataElements[node.childNodes[4].textContent] + '</em></small></span><span class="pull-right">&nbsp;&nbsp;<a class="label" onclick="closepop(\'text_'+id+'\')" >x</a></span></div><hr/><div><small><a href="#">add comment</a> &nbsp;|&nbsp; <a href="#">show comments</a></small></div>'
			
			
			if(typeof(dataElements[node.childNodes[4].textContent]) != 'undefined') {
				sub_content = dataElements[node.childNodes[4].textContent];
			}


			var popcontent='<div><span class="pull-right">&nbsp;&nbsp;<a class="label" onclick="closepop(\'text_'+id+'\')" >x</a></span><span><strong>'+ node.childNodes[4].textContent +'</strong><br/><small><em>' + sub_content;
			if(id=="node1")
				popcontent=popcontent + '</em></small></span></div><hr/><div><small><a href="#modal_'+wid+'" data-toggle="modal">view/add comments</a></small></div>';
			else
				popcontent=popcontent + '</em></small></span></div><hr/><div><small><a href="#modal_'+id+'" data-toggle="modal">view/add comments</a></small></div>';
			
			$("#text_"+id).popover({container:'body', html: true, content: popcontent, trigger: 'manual'});
			//on click 'text' event for each element -- toggle popover menu
			$("#text_"+id).click(function(e){
					//closes last clicked popover and opens the new one that was clicked
					if(currentPopover.length==0) {					
						currentPopover=e.target.id;
					}
					else {
						lastPopover=currentPopover;
						currentPopover=e.target.id;
					}
					if(lastPopover == currentPopover) { //close same popover on 2nd click
						closepop(lastPopover);
						$("#acc_"+lastPopover.substring(5)).collapse('hide');
						currentPopover='';
						lastPopover='';
					}
					else {  // close other popover and open new one
						closepop(lastPopover);
						$(this).popover('show');
						$("#acc_"+lastPopover.substring(5)).collapse('hide');
						$("#acc_"+e.target.id.substring(5)).collapse('show');
					}
					
				});
			
			//on click 'text' event for each element -- toggle popover menu
		    /*node.addEventListener(
			"click",
			(function(id) {
				return function(event) {
					//alert(node.childNodes[4].textContent + " (" + node.childNodes[0].textContent + ")" + " node clicked.");
					$("#text_"+id).popover('toggle')
				}
			})(id),
			false
		    );*/
		  }
		}

	$('.expandcollapse').click(function () {
        if ($(this).html() == "<i class=\"icon-plus-sign\"></i> Expand All") {
            $('#acc-container .collapse:not(.in)').each(function () {
                $(this).collapse("toggle");
            });
            $(this).html("<i class=\"icon-minus-sign\"></i> Collapse All (scroll)");
        }
        else {
            $('#acc-container .collapse.in').each(function () {
                $(this).collapse("toggle");
            });
            $(this).html("<i class=\"icon-plus-sign\"></i> Expand All");
        };
    });
	
	$('#acc-container').slimScroll({
		height: 'auto',
		position: 'right',
		alwaysVisible: true,
		railOpacity: 0.1,
		distance: '0px',
		color: '#ccc',
		wheelStep: 5
	});
}); //end document.ready


</script>
<script type="text/javascript" src="/static/js/jquery.slimscroll.min.js"></script>
{% endblock %}

{% block container %}
   <div class="leaderboard">
    <noscript>This page requires a javascript enabled browser.</noscript>
	<div align="center">
	  	<!-- <h3> Workflow: {{ wid }} </h3> -->
        <h2> {{ wid_info[0].username }} / {{ wid_info[0].name }} / {{ wid_info[0].composite_seq }} </h2>
        <div><span class="text-center">{{ wid_info[0].description }}</span></div>
        <div><span class="text-center muted"><small>workflow ID: {{ wid }}</small></span></div>
	</div>
    <div class="row-fluid">
    	<div class="span12">
        	<div class="row-fluid">
                <div id="left-container" class="span7">
                    <div>
                    	<small><a href="{{ url_for("graph", wid=wid) }}/jpg"><span id="img" class="label label-info">jpg</span></a></small>
                    </div>
                    <!-- svg start -->
                    {{ svg|safe }}
                    <!-- svg end -->

                    <div id="node_comments">
                        <div id="accordion2" class="accordion">
                        <div class="accordion-group">
                            <div class="accordian-heading">
                                <div style="padding-top:10px;padding-bottom:10px;">
                                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne"><small><i class="icon-plus-sign"></i> comments {% if num_comment %}({{ num_comment }}){% endif %}</small></a>
                                </div>                            
                            </div>
                            <div id="collapseOne" class="accordion-body collapse">
                        {% for obj in nodes.iteritems() %}
                            {% for n in obj %}
                                <div>
                                    <small>
                                            <a href="#modal_{{ n.uid }}"  data-toggle="modal">{{ n.name }}
                                            {% if n.comment %}
                                                {% for c in n.comment %}
                                                    {% if loop.last %} ({{ loop.length }}) {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            </a>                                                	
                                    </small>
                                    <div id="modal_{{ n.uid }}" class="modal hide" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                            <h4>{{ n.name }}
                                            {% if n.comment %}
                                                {% for c in n.comment %}
                                                    {% if loop.last %} ({{ loop.length }}) {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                (0)
                                            {% endif %}
                                            </h4>
                                            <small><a href="#add_{{ n.uid }}" data-parent="#accordion{{ n.uid }}" data-toggle="collapse">(+) add comment</a></small>
                                        </div>
                                        <div class="modal-body">
                                              <div class="accordion-body collapse" id="add_{{ n.uid }}">
                                                <div class="accordion-inner no-border bot-border">
                                                  <form action="{{ url_for("submit_comment") }}" method="post">
                                                <div><input type="hidden" name="parent_uid" value="{{ n.uid }}" /></div> 
                                                <div><textarea rows="2" class="span11" name="content"></textarea>&nbsp;&nbsp;<button type="submit" class="btn btn-mini">Submit</button></div>
                                                  </form>
                                                </div>
                                              </div>
                                            <ul>
                                                {% if n.comment %}
                                                    {% for c in n.comment %}
                                                        <li><small>{{ c.content }}  <span class="muted"><em>{{ c.user }} - {{ c.time }}</em></span> <a href="#add_{{ c.uid }}" class="text-success" data-parent="#accordion{{ c.uid }}" data-toggle="collapse"><em>(reply)</em></a></small> 
                                                           	 <div class="accordion-body collapse" id="add_{{ c.uid }}">
                                                                <div class="accordion-inner no-border bot-border">
                                                                  <form action="{{ url_for("submit_comment") }}" method="post">
                                                                  <!-- comment's uid -->
                                                                <div><input type="hidden" name="parent_uid" value="{{ c.uid }}" /></div> 
                                                                <div><textarea rows="2" class="span11" name="content"></textarea>&nbsp;&nbsp;<button type="submit" class="btn btn-mini">Submit</button></div>
                                                                  </form>
                                                                </div>
                                                              </div>
                                                        </li>
                                                    {% endfor %}
                                                {% endif %}                                        
                                            </ul>
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-mini" data-dismiss="modal" aria-hidden="true">Close</button>
                                        </div>
                                    </div>
                                 </div>
                             {% endfor %}
                        {% endfor %}
                        	</div><!-- end collapseone -->
                        </div>
                        </div> <!--end accordion parent --> 
                    </div>           	                    
                </div> <!-- end span7 -->
                {% if nodes %}
                <div class="span4 offset1">
                <h4>Workflow Nodes:</h4>
                <button class="btn btn-mini btn-link expandcollapse"><i class="icon-plus-sign"></i> Expand All</button>
                	<div id="acc-container">
                	<div id="accordion" class="accordion">
                    {% for obj in nodes.iteritems() %}
                        {% for n in obj %}
                            {% if (n.name and n.type != "workflow") %}
                                    <div>
                                        <a href="#acc_{{ n.uid }}" data-toggle="collapse">{{ n.name }}</a> <!-- <span class="muted"><em><small>({{ n.type }})</small></em></span>  -->
                                                        {% if n.data %}
                                                            {% for x in n.data %}
                                                                 {% if x.time %}                                                	
                                                                <span class="muted"><small><small><em>- {{ x.time }}</em></small></small></span>
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% endif %}                                     
                                            <div class="accordion-body collapse" id="acc_{{ n.uid }}">
                                                <div class="accordion-inner no-border">
                                                    <ul>
                                                        {% if n.data %}
                                                            {% for x in n.data %}
                                                                <li><small>{{ x.description }}</small></li>
                                                                {% if x.uri %}                                                	
                                                                <li><small>uri: {{ x.uri }}</small></li>
                                                                {% endif %}                                                                
                                                                {% if x.time %}                                                	
                                                                <li><small>time: {{ x.time }}</small></li>
                                                                {% endif %}
                                                                <li><small>uid: {{ x.uid }}</small></li>
                                                            {% endfor %}
                                                        {% endif %}
                                                        {% if n.metadata %}
                                                            <li><small>Metadata:</small>
                                                            <ul>
                                                            {% for md in n.metadata %}
                                                                <li>
                                                                    <small>{{ md.key }}: {{ md.value }}</small>
                                                                    {% if md.time %}                                                	
                                                                    <ul><li><small>time: {{ md.time }}</small></li></ul>
                                                                    {% endif %}
                                                                </li>
                                                            {% endfor %}
                                                            </ul>
                                                            </li>
                                                        {% endif %}
                                                        {% if n.comment %}
                                                        <li><small>Comments:</small>
                                                            <ul>
                                                            {% for c in n.comment %}
                                                                <li><small>{{ c.content }} | <em>by {{ c.user }} - {{ c.time }}</em></small> 
                                                                </li>
                                                            {% endfor %}
                                                            </ul>
                                                        </li>
                                                        {% endif %}                                        
                                                    </ul>
                                                </div>
                                            </div><!-- end accordion-body -->
                                     </div>
                            {% endif %}
                         {% endfor %}
                    {% endfor %}
                    </div> <!--end accordion parent -->
                    </div> <!-- end acc-container -->
                </div> <!-- end span3 offset1 -->
                {% endif %}
             </div> <!-- end row-fluid -->
		<div class="row-fluid">
        	<div class="span7">

            </div><!-- end span7 -->
        </div> <!-- end row-fluid -->
        </div> <!-- end span12 -->
    </div><!-- end row-fluid -->
  </div> <!-- end leaderboard -->
     


{% endblock %} 
